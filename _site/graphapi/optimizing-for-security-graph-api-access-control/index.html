<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Optimizing for security: Graph API Access Control | Code Artisan Journey</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Optimizing for security: Graph API Access Control" />
<meta name="author" content="Thomas" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Why should restrictions be imposed on GraphAPI access?" />
<meta property="og:description" content="Why should restrictions be imposed on GraphAPI access?" />
<link rel="canonical" href="http://localhost:4000/graphapi/optimizing-for-security-graph-api-access-control/" />
<meta property="og:url" content="http://localhost:4000/graphapi/optimizing-for-security-graph-api-access-control/" />
<meta property="og:site_name" content="Code Artisan Journey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-02-04T19:36:19+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Optimizing for security: Graph API Access Control" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Thomas"},"dateModified":"2024-02-04T19:36:19+01:00","datePublished":"2024-02-04T19:36:19+01:00","description":"Why should restrictions be imposed on GraphAPI access?","headline":"Optimizing for security: Graph API Access Control","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/graphapi/optimizing-for-security-graph-api-access-control/"},"url":"http://localhost:4000/graphapi/optimizing-for-security-graph-api-access-control/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Code Artisan Journey" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Code Artisan Journey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Optimizing for security: Graph API Access Control</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-02-04T19:36:19+01:00" itemprop="datePublished">Feb 4, 2024
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Thomas</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    ### Why should restrictions be imposed on GraphAPI access?

Granting permissions to Entra ID App registrations for access via the Graph API to Azure tenants can provide significant benefits, particularly in service automation scenarios.

However, managing unrestricted access to these registrations can be inconvenient and a known risk. It’s crucial to establish conditional restrictions to ensure controlled access to your Azure Tenant via the Graph API.

Enter…. the Conditional Access for workload identities!

First, what are workload identities:  
As Microsoft describes it, *“A workload identity is an identity you assign to a software workload (such as an application, service, script, or container) to authenticate and access other services and resources. “*

Microsoft now also offers ‘Entra Workload ID Premium’ to use workload identities within Conditional Access. These workload identities serve as the gateway, granting applications or service principals access to resources like the Graph API.

So, in this post, we connect to the Graph API as a workload identity via an IP restriction enforced by a Conditional Access policy.

<details class="wp-block-details has-vivid-red-color has-text-color has-link-color wp-elements-44103e58f4665527c37b842beb47c688 is-layout-flow wp-block-details-is-layout-flow" style="font-size:18px"><summary>Disclaimer</summary>The instructions below assume that you have a Microsoft Entra Workload-ID license, which enables you to create Conditional Access policies based on workload identities, such as a service principal.

</details>### Creating the named location

The journey begins with creating a named location, the first step in defining the IPs we want to exclude from our conditional access policy.

To start this, navigate to the Conditional Access management blade. ([The quick way](https://enca.cmd.ms/), thanks to Merill Fernando from [merill.net](http://merill.net)) and select named locations, as shown in the below example.

![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2023/12/CA-Blade-Highlight-Example.png?resize=640%2C509&ssl=1)

In the Named locations blade I then create a new location as shown below.

![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2023/12/CA-Blade-NewNamedLocation.png?resize=386%2C399&ssl=1)

### Assigning the named location to a conditional access policy.

To make the named location a requirement in the conditional access policy, we have to assign it to a new or existing conditional access policy.  
  
For the purpose of this post, we are creating a new policy by navigating to the Conditional Access blade and selecting the workload identity we wish to control via Conditional Access

![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2023/12/CA-Blade-NewWorkloadID.png?resize=606%2C869&ssl=1

Then after selecting the workload identity, we want to apply the restrictions to; we give the policy a name and select the earlier created named location as an exclusion, so that only that location is allowed to bypass the policy.  
  
In the access controls, we select ‘Block access’ so that every other location other than the selected named location is blocked from access to the workload identity.

![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2023/12/CA-Blade-NewWorkloadID-NamedLocation.png?resize=640%2C549&ssl=1)

### How does this work in practice?

As published in [my earlier blog post](https://codeartisanjourney.com/graphapi/a-simplified-guide-connecting-to-microsoft-graph-api-with-powershell/) to easily generate a Graph API access token, we are re-using some code.

When we request an access token via the trusted named location, we get the next result:

![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2024/01/CA-Run-ExampleWithOutRestriction-1024x491.png?resize=640%2C307)

And then when we request an access token outside of our trusted named location, we get the next result back:

<![](https://raw.githubusercontent.com/ThomasKlijnman/thomasklijnman.github.io/main/_images/2024/01/CA-Run-ExampleWithRestriction-1024x406.png?resize=640%2C254)

### Conclusion

When creating workload identities to use in, for example, service automation products, we also need to pay attention to the access controls for these identities. This aspect can be overlooked, leading to an unnecessary risk.

Unfortunately, this feature is not a standard one to configure without adding or purchasing extra licenses.

In an upcoming post, I’ll delve into how to best maintain minimal permissions when creating a workload identity for use in automation products (scripts, etc.), as most workload identities typically do not need any more permissions than necessary.
  </div><a class="u-url" href="/graphapi/optimizing-for-security-graph-api-access-control/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Code Artisan Journey</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Code Artisan Journey</li><li><a class="u-email" href="mailto:thomas@klijnman.nl">thomas@klijnman.nl</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The Code Artisan Journey</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
